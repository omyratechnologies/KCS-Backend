<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Payment - KCS LMS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        h2 {
            color: #555;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .student-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .payment-history {
            margin-top: 20px;
        }

        .payment-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            transition: transform 0.2s;
        }

        .payment-item:hover {
            transform: translateX(5px);
        }

        .payment-item.success {
            border-left-color: #28a745;
        }

        .payment-item.failed {
            border-left-color: #dc3545;
        }

        .payment-item.pending {
            border-left-color: #ffc107;
        }

        .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .payment-amount {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .payment-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .payment-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 13px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 10px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .installment-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üìö Student Payment Portal</h1>
            <p style="color: #666; margin-bottom: 20px;">‚úÖ <strong>Auto-Fetch Enabled:</strong> Your name, email, and phone are automatically fetched from your profile. No need to enter them!</p>
            
            <div class="student-info">
                <div class="info-item">
                    <span class="info-label">Student ID</span>
                    <span class="info-value" id="studentId">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Student Name</span>
                    <span class="info-value" id="studentName">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Email</span>
                    <span class="info-value" id="studentEmail">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Phone</span>
                    <span class="info-value" id="studentPhone">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Class</span>
                    <span class="info-value" id="className">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Academic Year</span>
                    <span class="info-value" id="academicYear">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Total Fee</span>
                    <span class="info-value" id="totalFee">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">One-Time Amount</span>
                    <span class="info-value" id="oneTimeAmount" style="color: #667eea;">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Amount Paid</span>
                    <span class="info-value" id="amountPaid" style="color: #28a745;">‚Çπ0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Amount Due</span>
                    <span class="info-value" id="amountDue" style="color: #dc3545;">Loading...</span>
                </div>
            </div>

            <div id="errorMessage"></div>
            <div id="successMessage"></div>

            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;">
                <strong>‚ö†Ô∏è Sandbox Mode - How to See Amount Paid:</strong><br>
                1. Click "Proceed to Payment" below<br>
                2. Complete payment with test card: <strong>4111 1111 1111 1111</strong> (CVV: 123, Expiry: 12/26)<br>
                3. After successful payment, click <strong>"üîÑ Check Status"</strong> on the pending payment<br>
                4. Status will change PENDING ‚Üí SUCCESS<br>
                5. "Amount Paid" will update immediately (only SUCCESS payments count)<br>
                <br>
                <strong>Note:</strong> Amount Paid = ‚Çπ0 means NO payments are marked SUCCESS yet. All PENDING/FAILED payments don't count.
            </div>

            <h2>üí≥ Make Payment</h2>
            
            <label for="paymentType" style="font-weight: 600; color: #555;">Select Payment Type:</label>
            <select id="paymentType">
                <option value="one_time">One Time Payment (Full Amount)</option>
                <option value="installment" selected>Installment Payment</option>
            </select>

            <div id="installmentSection">
                <label for="installmentNumber" style="font-weight: 600; color: #555;">Select Installment:</label>
                <select id="installmentNumber">
                    <option value="">-- Select Installment --</option>
                </select>
                <div class="installment-info" id="installmentInfo" style="display: none;"></div>
            </div>

            <button class="btn" id="payButton" onclick="createPayment()">
                üí∞ Proceed to Payment
            </button>
        </div>

        <div class="card">
            <h2>üìä Payment History</h2>
            <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                <button onclick="syncPaymentsWithCashfree()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                    üîÑ Sync with Cashfree
                </button>
                <button onclick="loadFeeStructure()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    üìã Refresh History
                </button>
                <div style="flex: 1; text-align: right; color: #666; font-size: 13px; padding-top: 8px;">
                    Click button to manually refresh (webhooks update automatically)
                </div>
            </div>
            <div id="paymentHistory">
                <div class="loading">Click "Refresh History" to load payment data</div>
            </div>
        </div>
    </div>

    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
    <script>
        // ========== CONFIGURATION ==========
        // Student token - UPDATED
        const STUDENT_TOKEN = 'eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiMTA4MWMwMTQtN2M3OS00OTA2LWIwZDAtM2NjNmY3OWI3MTQ4IiwidXNlcl90eXBlIjoiU3R1ZGVudCIsImNhbXB1c19pZCI6IjFlNTFjZDk2LWI5N2YtNDY2ZC04ODA2LTA4NGRmYmUyY2E1ZSIsInNlc3Npb25faWQiOiJlYmI1NmJlNDZiZWZhYjNhZTUxZmRiY2VlNTNhMjExYyIsImV4cCI6MTc2Mzg4NDE2MX0.HTfMwmRkBK9M1D4PY6LTd3zNW5cGMxjMrl8XHktOf6Dpe24Km17lLynktCvuJc8h67_NUEMsnbH1ZNZRGxNxBA';
        
        // Student ID from token
        const STUDENT_ID = '7fd6aad9-bdc7-41f1-aafb-ad15261d5d8c';
        
        // Fee structure ID - UPDATED
        const FEE_STRUCTURE_ID = '8f51b658-6bf1-4e6f-83f0-014cf5f2b11f';
        
        // API Base URL
        const API_BASE_URL = 'http://localhost:4500/api';

        // Initialize Cashfree SDK
        let cashfree;
        const initializeSDK = async () => {
            cashfree = await Cashfree({
                mode: "sandbox"
            });
        };
        initializeSDK();

        // Fee structure data
        let feeStructure = null;
        let paymentHistory = [];
        let studentInfo = null;

        // Load initial data
        window.addEventListener('DOMContentLoaded', async () => {
            showLoading();
            await loadStudentInfo();
            await loadBasicFeeStructure(); // Load ONLY fee structure, no payment history
            setupPaymentTypeListener();
            hideLoading();
        });

        function showLoading() {
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            overlay.innerHTML = '<div style="background:white;padding:30px;border-radius:12px;text-align:center;"><div style="font-size:20px;color:#667eea;margin-bottom:10px;">üîÑ Loading...</div><div style="color:#666;">Fetching student details and fee structure</div></div>';
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
        }

        async function loadStudentInfo() {
            try {
                // Decode JWT to get student ID
                const tokenParts = STUDENT_TOKEN.split('.');
                const payload = JSON.parse(atob(tokenParts[1]));
                const studentId = payload.user_id;
                
                document.getElementById('studentId').textContent = studentId;

                // Try to fetch student details from users endpoint
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${studentId}`, {
                        headers: {
                            'Authorization': `Bearer ${STUDENT_TOKEN}`
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const student = result.data;
                        
                        document.getElementById('studentName').textContent = `${student.first_name} ${student.last_name}`;
                        document.getElementById('studentEmail').textContent = student.email;
                        document.getElementById('studentPhone').textContent = student.phone;
                    } else {
                        // If endpoint doesn't exist, show placeholder
                        document.getElementById('studentName').textContent = 'Auto-fetched by backend';
                        document.getElementById('studentEmail').textContent = 'Auto-fetched by backend';
                        document.getElementById('studentPhone').textContent = 'Auto-fetched by backend';
                    }
                } catch (err) {
                    console.log('Student endpoint not available, details will be auto-fetched on payment');
                    document.getElementById('studentName').textContent = 'Auto-fetched by backend ‚úÖ';
                    document.getElementById('studentEmail').textContent = 'Auto-fetched by backend ‚úÖ';
                    document.getElementById('studentPhone').textContent = 'Auto-fetched by backend ‚úÖ';
                }
            } catch (error) {
                console.error('Error loading student info:', error);
                showError('Failed to load student information');
            }
        }

        async function loadBasicFeeStructure() {
            try {
                const response = await fetch(`${API_BASE_URL}/fee-structures/${FEE_STRUCTURE_ID}`, {
                    headers: {
                        'Authorization': `Bearer ${STUDENT_TOKEN}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load fee structure');

                const result = await response.json();
                feeStructure = result.data;

                // Update UI with fee structure details (without payment calculations)
                document.getElementById('className').textContent = feeStructure.class_name || 'N/A';
                document.getElementById('academicYear').textContent = feeStructure.academic_year || 'N/A';
                document.getElementById('totalFee').textContent = `‚Çπ${feeStructure.total_amount.toLocaleString('en-IN')}`;
                document.getElementById('oneTimeAmount').textContent = `‚Çπ${feeStructure.one_time_amount.toLocaleString('en-IN')}`;
                document.getElementById('amountDue').textContent = `‚Çπ${feeStructure.total_amount.toLocaleString('en-IN')}`;

                // Show fee description
                if (feeStructure.fee_description) {
                    console.log('Fee Structure Details:\n', feeStructure.fee_description);
                }

                // Populate ALL installments (no filtering on page load)
                if (feeStructure.installments && feeStructure.installments.length > 0) {
                    const installmentSelect = document.getElementById('installmentNumber');
                    installmentSelect.innerHTML = '<option value="">-- Select Installment --</option>';
                    
                    feeStructure.installments.forEach((inst) => {
                        const option = document.createElement('option');
                        option.value = inst.installment_number;
                        const dueDate = new Date(inst.due_date).toLocaleDateString('en-IN', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                        option.textContent = `Installment ${inst.installment_number} - ‚Çπ${inst.amount.toLocaleString('en-IN')} (Due: ${dueDate})`;
                        installmentSelect.appendChild(option);
                    });
                }

                console.log('‚úÖ Fee structure loaded (payment history NOT loaded yet - click Refresh History button)');
            } catch (error) {
                console.error('Error loading fee structure:', error);
                showError('Failed to load fee structure details');
            }
        }

        async function loadFeeStructure() {
            try {
                const response = await fetch(`${API_BASE_URL}/fee-structures/${FEE_STRUCTURE_ID}`, {
                    headers: {
                        'Authorization': `Bearer ${STUDENT_TOKEN}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load fee structure');

                const result = await response.json();
                feeStructure = result.data;

                // First load payment history to check paid installments
                await loadPaymentHistory();

                // Calculate paid installments
                const paidInstallments = paymentHistory
                    .filter(p => p.payment_status === 'SUCCESS' && p.payment_type === 'installment')
                    .map(p => p.installment_number);

                // Calculate total paid amount
                const totalPaid = paymentHistory
                    .filter(p => p.payment_status === 'SUCCESS')
                    .reduce((sum, p) => sum + p.order_amount, 0);

                // Calculate remaining amount
                const remainingAmount = feeStructure.total_amount - totalPaid;

                // Update one-time amount to remaining amount
                feeStructure.one_time_amount = remainingAmount;

                // Update UI with fee structure details
                document.getElementById('className').textContent = feeStructure.class_name || 'N/A';
                document.getElementById('academicYear').textContent = feeStructure.academic_year || 'N/A';
                document.getElementById('totalFee').textContent = `‚Çπ${feeStructure.total_amount.toLocaleString('en-IN')}`;
                document.getElementById('oneTimeAmount').textContent = `‚Çπ${remainingAmount.toLocaleString('en-IN')}`;
                document.getElementById('amountDue').textContent = `‚Çπ${remainingAmount.toLocaleString('en-IN')}`;

                // Show fee description as a tooltip or info section
                if (feeStructure.fee_description) {
                    console.log('Fee Structure Details:\n', feeStructure.fee_description);
                }

                // Populate installment dropdown - EXCLUDE PAID INSTALLMENTS
                if (feeStructure.installments && feeStructure.installments.length > 0) {
                    const installmentSelect = document.getElementById('installmentNumber');
                    installmentSelect.innerHTML = '<option value="">-- Select Installment --</option>';
                    
                    // Filter out paid installments
                    const unpaidInstallments = feeStructure.installments.filter(
                        inst => !paidInstallments.includes(inst.installment_number)
                    );

                    if (unpaidInstallments.length === 0) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '‚úÖ All installments paid!';
                        option.disabled = true;
                        installmentSelect.appendChild(option);
                        document.querySelector('input[name="paymentType"][value="installment"]').disabled = true;
                    } else {
                        unpaidInstallments.forEach((inst) => {
                            const option = document.createElement('option');
                            option.value = inst.installment_number;
                            const dueDate = new Date(inst.due_date).toLocaleDateString('en-IN', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                            option.textContent = `Installment ${inst.installment_number} - ‚Çπ${inst.amount.toLocaleString('en-IN')} (Due: ${dueDate})`;
                            installmentSelect.appendChild(option);
                        });
                    }

                    // Update installment info to show remaining
                    const remainingInstallmentAmount = unpaidInstallments.reduce((sum, inst) => sum + inst.amount, 0);
                    console.log(`üí∞ Remaining Installments: ${unpaidInstallments.length} installments = ‚Çπ${remainingInstallmentAmount.toLocaleString('en-IN')}`);
                }

                // Disable payment if fully paid
                if (remainingAmount <= 0) {
                    document.getElementById('payButton').disabled = true;
                    document.getElementById('payButton').textContent = '‚úÖ Fee Fully Paid';
                    document.querySelector('input[name="paymentType"][value="one_time"]').disabled = true;
                    document.querySelector('input[name="paymentType"][value="installment"]').disabled = true;
                    showSuccess('‚úÖ All fees have been paid! No further payments required.');
                }
            } catch (error) {
                console.error('Error loading fee structure:', error);
                showError('Failed to load fee structure details');
            }
        }

        async function syncPaymentsWithCashfree() {
            try {
                // Show loading state
                const syncButton = event.target;
                syncButton.disabled = true;
                syncButton.textContent = '‚è≥ Syncing...';

                const response = await fetch(`${API_BASE_URL}/cashfree-payments/sync-payments`, {
                    headers: {
                        'Authorization': `Bearer ${STUDENT_TOKEN}`
                    }
                });

                if (!response.ok) throw new Error('Failed to sync payments');

                const result = await response.json();
                
                console.log('üîÑ Sync Results:');
                console.log(`   Total Checked: ${result.data.total_checked}`);
                console.log(`   Total Updated: ${result.data.total_updated}`);
                console.log(`   Paid Count: ${result.data.paid_count}`);
                console.log(`   Expired/Failed: ${result.data.expired_failed_count}`);
                
                if (result.data.errors && result.data.errors.length > 0) {
                    console.warn(`   ‚ö†Ô∏è Errors: ${result.data.errors.length}`);
                }

                // Show success message
                if (result.data.total_updated > 0) {
                    showSuccess(`‚úÖ Synced! Updated ${result.data.total_updated} payment(s). ${result.data.paid_count} marked as PAID.`);
                } else {
                    showSuccess('‚úÖ All payments are already up to date!');
                }

                // Reload payment history
                await loadPaymentHistory();

            } catch (error) {
                console.error('Error syncing payments:', error);
                showError('Failed to sync payments with Cashfree');
            } finally {
                // Restore button
                const syncButton = document.querySelector('button[onclick="syncPaymentsWithCashfree()"]');
                if (syncButton) {
                    syncButton.disabled = false;
                    syncButton.textContent = 'üîÑ Sync with Cashfree';
                }
            }
        }

        async function loadPaymentHistory() {
            try {
                const response = await fetch(`${API_BASE_URL}/cashfree-payments/my-payments`, {
                    headers: {
                        'Authorization': `Bearer ${STUDENT_TOKEN}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load payment history');

                const result = await response.json();
                paymentHistory = result.data.payments || [];

                console.log(`üìä Payment Summary for Student ${result.data.student_id}:`);
                console.log(`   Total Payments: ${paymentHistory.length}`);
                
                // Calculate totals by status
                const successPayments = paymentHistory.filter(p => p.payment_status === 'SUCCESS');
                const pendingPayments = paymentHistory.filter(p => p.payment_status === 'PENDING');
                const failedPayments = paymentHistory.filter(p => p.payment_status === 'FAILED');
                
                const totalPaid = successPayments.reduce((sum, p) => sum + p.order_amount, 0);
                const totalPending = pendingPayments.reduce((sum, p) => sum + p.order_amount, 0);
                
                console.log(`   ‚úÖ SUCCESS: ${successPayments.length} payments = ‚Çπ${totalPaid.toLocaleString('en-IN')}`);
                console.log(`   ‚è≥ PENDING: ${pendingPayments.length} payments = ‚Çπ${totalPending.toLocaleString('en-IN')}`);
                console.log(`   ‚ùå FAILED: ${failedPayments.length} payments`);

                document.getElementById('amountPaid').textContent = `‚Çπ${totalPaid.toLocaleString('en-IN')}`;
                
                if (feeStructure) {
                    const amountDue = Math.max(0, feeStructure.total_amount - totalPaid);
                    document.getElementById('amountDue').textContent = `‚Çπ${amountDue.toLocaleString('en-IN')}`;
                    
                    // Check if fully paid
                    if (totalPaid >= feeStructure.total_amount) {
                        showSuccess('‚úÖ Fee fully paid! Total: ‚Çπ' + totalPaid.toLocaleString('en-IN'));
                        document.getElementById('payButton').disabled = true;
                        document.getElementById('payButton').textContent = '‚úÖ Fee Fully Paid';
                    } else if (totalPaid > 0) {
                        showSuccess(`üí∞ Paid: ‚Çπ${totalPaid.toLocaleString('en-IN')} | Remaining: ‚Çπ${amountDue.toLocaleString('en-IN')}`);
                    }
                }

                displayPaymentHistory(paymentHistory);
            } catch (error) {
                console.error('Error loading payment history:', error);
                document.getElementById('paymentHistory').innerHTML = '<div class="error">Failed to load payment history</div>';
            }
        }

        function displayPaymentHistory(payments) {
            const container = document.getElementById('paymentHistory');
            
            if (!payments || payments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p>No payments yet</p>
                        <p style="font-size: 14px; color: #999; margin-top: 10px;">Make your first payment to see it here</p>
                    </div>
                `;
                return;
            }

            // Sort by date, newest first
            const sortedPayments = [...payments].sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );

            container.innerHTML = sortedPayments.map(payment => {
                const statusClass = payment.payment_status === 'SUCCESS' ? 'success' : 
                                  payment.payment_status === 'FAILED' ? 'failed' : 'pending';
                
                const statusBadgeClass = payment.payment_status === 'SUCCESS' ? 'status-success' : 
                                        payment.payment_status === 'FAILED' ? 'status-failed' : 'status-pending';

                // Format created date (when order was created)
                const createdDate = new Date(payment.created_at);
                const createdFormatted = createdDate.toLocaleString('en-IN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });

                // Format payment time (when payment was actually completed)
                let paymentTimeFormatted = '';
                if (payment.payment_time) {
                    const paymentTime = new Date(payment.payment_time);
                    paymentTimeFormatted = paymentTime.toLocaleString('en-IN', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                }

                return `
                    <div class="payment-item ${statusClass}">
                        <div class="payment-header">
                            <div class="payment-amount">‚Çπ${payment.order_amount.toLocaleString('en-IN')}</div>
                            <span class="payment-status ${statusBadgeClass}">${payment.payment_status || 'PENDING'}</span>
                        </div>
                        <div class="payment-details">
                            <div><strong>Type:</strong> ${payment.payment_type === 'installment' ? `Installment #${payment.installment_number || 'N/A'}` : 'One-Time Full Payment'}</div>
                            <div><strong>Order Created:</strong> ${createdFormatted}</div>
                            ${paymentTimeFormatted ? `<div><strong>‚úÖ Payment Completed:</strong> ${paymentTimeFormatted}</div>` : ''}
                            <div><strong>Order ID:</strong> ${payment.order_id}</div>
                            ${payment.cf_order_id ? `<div><strong>Cashfree ID:</strong> ${payment.cf_order_id}</div>` : ''}
                            ${payment.payment_method ? `<div><strong>Method:</strong> ${payment.payment_method}</div>` : ''}
                            ${payment.cf_payment_id ? `<div><strong>Payment ID:</strong> ${payment.cf_payment_id}</div>` : ''}
                            ${payment.payment_link && payment.payment_status === 'PENDING' ? `<div><a href="${payment.payment_link}" target="_blank" style="color: #667eea; text-decoration: none;">üîó Continue Payment</a></div>` : ''}
                            ${payment.payment_status === 'PENDING' && payment.cf_order_id ? `<div><button onclick="checkPaymentStatus('${payment.cf_order_id}')" style="padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 5px;">üîÑ Check Status</button></div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function setupPaymentTypeListener() {
            const paymentTypeSelect = document.getElementById('paymentType');
            const installmentSection = document.getElementById('installmentSection');
            const installmentNumberSelect = document.getElementById('installmentNumber');

            paymentTypeSelect.addEventListener('change', (e) => {
                if (e.target.value === 'installment') {
                    installmentSection.style.display = 'block';
                } else {
                    installmentSection.style.display = 'none';
                }
            });

            installmentNumberSelect.addEventListener('change', (e) => {
                const installmentNumber = parseInt(e.target.value);
                if (installmentNumber && feeStructure) {
                    const installment = feeStructure.installments.find(inst => inst.installment_number === installmentNumber);
                    if (installment) {
                        const infoDiv = document.getElementById('installmentInfo');
                        infoDiv.style.display = 'block';
                        const dueDate = new Date(installment.due_date).toLocaleDateString('en-IN', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        infoDiv.innerHTML = `
                            <strong>üìã Installment ${installment.installment_number} Details</strong><br>
                            üí∞ Amount: ‚Çπ${installment.amount.toLocaleString('en-IN')}<br>
                            üìÖ Due Date: ${dueDate}<br>
                            ${installment.late_fee ? `‚ö†Ô∏è Late Fee (if overdue): ‚Çπ${installment.late_fee.toLocaleString('en-IN')}<br>` : ''}
                            ${installment.description ? `üìù ${installment.description}` : ''}
                        `;
                    }
                } else {
                    document.getElementById('installmentInfo').style.display = 'none';
                }
            });
        }

        async function createPayment() {
            const payButton = document.getElementById('payButton');
            const paymentType = document.getElementById('paymentType').value;
            const installmentNumber = document.getElementById('installmentNumber').value;

            if (paymentType === 'installment' && !installmentNumber) {
                showError('Please select an installment');
                return;
            }

            payButton.disabled = true;
            payButton.textContent = 'Creating payment order...';
            clearMessages();

            try {
                const requestBody = {
                    fee_structure_id: FEE_STRUCTURE_ID,
                    payment_type: paymentType,
                    return_url: window.location.href
                };

                if (paymentType === 'installment') {
                    requestBody.installment_number = parseInt(installmentNumber);
                }

                console.log('Payment request (NO customer details - auto-fetched):', requestBody);

                const response = await fetch(`${API_BASE_URL}/cashfree-payments/create-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${STUDENT_TOKEN}`
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to create payment order');
                }

                console.log('‚úÖ Payment order created:', result.data);

                // Initialize payment with Cashfree
                const checkoutOptions = {
                    paymentSessionId: result.data.payment_session_id,
                    returnUrl: window.location.href
                };

                await cashfree.checkout(checkoutOptions);
                
                console.log('Payment initiated successfully');
                
                // Reload payment history after a delay
                setTimeout(async () => {
                    await loadPaymentHistory();
                    showSuccess('Payment window opened! Complete payment in the popup.');
                }, 1000);

            } catch (error) {
                console.error('Payment creation error:', error);
                showError(error.message || 'Failed to create payment. Please try again.');
            } finally {
                payButton.disabled = false;
                payButton.textContent = 'üí∞ Proceed to Payment';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                errorDiv.innerHTML = '';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.innerHTML = `<div class="success-message">${message}</div>`;
            setTimeout(() => {
                successDiv.innerHTML = '';
            }, 5000);
        }

        function clearMessages() {
            document.getElementById('errorMessage').innerHTML = '';
            document.getElementById('successMessage').innerHTML = '';
        }

        async function checkPaymentStatus(cfOrderId) {
            try {
                showSuccess('üîÑ Checking payment status...');
                
                const response = await fetch(`${API_BASE_URL}/cashfree-payments/order-status/${cfOrderId}`, {
                    headers: {
                        'Authorization': `Bearer ${STUDENT_TOKEN}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to check payment status');
                }

                const result = await response.json();
                console.log('Payment status check result:', result);

                if (result.success) {
                    showSuccess(`‚úÖ Payment status updated! Status: ${result.data.order_status}`);
                    
                    // Reload payment history to show updated status
                    setTimeout(async () => {
                        await loadPaymentHistory();
                    }, 1000);
                } else {
                    showError(result.message || 'Failed to check payment status');
                }
            } catch (error) {
                console.error('Error checking payment status:', error);
                showError('Failed to check payment status. Please try again.');
            }
        }

        // Check for payment completion on page load (from return URL)
        if (window.location.search.includes('order_id')) {
            setTimeout(async () => {
                await loadPaymentHistory();
                showSuccess('‚úÖ Payment status updated! Check your payment history below.');
            }, 1500);
        }

        // Auto-refresh payment history every 30 seconds
        setInterval(async () => {
            console.log('Auto-refreshing payment history...');
            await loadPaymentHistory();
        }, 30000);
    </script>
</body>
</html>
