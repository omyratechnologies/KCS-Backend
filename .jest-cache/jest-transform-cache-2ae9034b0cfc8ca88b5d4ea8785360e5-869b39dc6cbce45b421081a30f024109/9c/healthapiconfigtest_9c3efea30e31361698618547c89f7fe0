402b845e6b6fb84efeadaa98b4ff20e3
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
(0, globals_1.describe)("Health API Configuration", () => {
    (0, globals_1.describe)("Route Registration", () => {
        (0, globals_1.it)("should register health endpoints without authentication middleware", async () => {
            // Test that our health routes are configured correctly
            const routeConfig = {
                publicRoutes: [
                    "/tmp",
                    "/auth",
                    "/health", // This should be before authentication middleware
                ],
                protectedRoutes: [
                    "/android-apk",
                    "/dashboard",
                    "/user",
                    "/campus",
                    // ... all other routes
                ],
            };
            // Verify health routes are in public section
            (0, globals_1.expect)(routeConfig.publicRoutes).toContain("/health");
            (0, globals_1.expect)(routeConfig.protectedRoutes).not.toContain("/health");
        });
        (0, globals_1.it)("should have all required health endpoints", async () => {
            const expectedHealthEndpoints = [
                "GET /api/health", // Basic health check
                "GET /api/health/database", // Database connectivity
                "GET /api/health/webrtc", // WebRTC service status
            ];
            for (const endpoint of expectedHealthEndpoints) {
                (0, globals_1.expect)(endpoint).toMatch(/^GET \/api\/health/);
            }
        });
    });
    (0, globals_1.describe)("Health Endpoint Responses", () => {
        (0, globals_1.it)("should return proper response format for health checks", async () => {
            const mockHealthResponse = {
                success: true,
                message: "Application is healthy",
                timestamp: new Date().toISOString(),
                version: "1.0.0",
                environment: "test",
            };
            // Test response structure
            (0, globals_1.expect)(mockHealthResponse).toHaveProperty("success");
            (0, globals_1.expect)(mockHealthResponse).toHaveProperty("message");
            (0, globals_1.expect)(mockHealthResponse).toHaveProperty("timestamp");
            (0, globals_1.expect)(typeof mockHealthResponse.success).toBe("boolean");
            (0, globals_1.expect)(typeof mockHealthResponse.message).toBe("string");
        });
        (0, globals_1.it)("should handle database health check errors gracefully", async () => {
            const mockDatabaseError = {
                success: false,
                message: "Database connection failed",
                error: "Connection timeout",
                timestamp: new Date().toISOString(),
                service: "Ottoman/Couchbase",
                suggestions: [
                    "Check if database service is running",
                    "Verify environment variables",
                    "Check network connectivity to database",
                ],
            };
            (0, globals_1.expect)(mockDatabaseError.success).toBe(false);
            (0, globals_1.expect)(mockDatabaseError).toHaveProperty("suggestions");
            (0, globals_1.expect)(Array.isArray(mockDatabaseError.suggestions)).toBe(true);
        });
        (0, globals_1.it)("should provide WebRTC service status", async () => {
            const mockWebRTCResponse = {
                success: true,
                message: "WebRTC service is healthy",
                timestamp: new Date().toISOString(),
                details: {
                    mediasoup_workers: 2,
                    active_connections: 0,
                    status: "ready",
                },
            };
            (0, globals_1.expect)(mockWebRTCResponse.success).toBe(true);
            (0, globals_1.expect)(mockWebRTCResponse).toHaveProperty("details");
        });
    });
    (0, globals_1.describe)("Authentication Bypass", () => {
        (0, globals_1.it)("should not require Authorization header for health endpoints", async () => {
            // Simulate requests without auth headers
            const requestsWithoutAuth = [
                { url: "/api/health", method: "GET" },
                { url: "/api/health/database", method: "GET" },
                { url: "/api/health/webrtc", method: "GET" },
            ];
            for (const req of requestsWithoutAuth) {
                // These should not require Authorization header
                (0, globals_1.expect)(req.url).toMatch(/^\/api\/health/);
                (0, globals_1.expect)(req.method).toBe("GET");
                // No Authorization header needed
            }
        });
        (0, globals_1.it)("should verify other endpoints still require authentication", async () => {
            const protectedEndpoints = ["/api/user", "/api/dashboard", "/api/classes", "/api/courses"];
            for (const endpoint of protectedEndpoints) {
                // These should require authentication
                (0, globals_1.expect)(endpoint).not.toMatch(/^\/api\/health/);
            }
        });
    });
    (0, globals_1.describe)("CI/CD Integration", () => {
        (0, globals_1.it)("should be compatible with Jenkins health checks", async () => {
            const jenkinsHealthCheck = {
                endpoint: "/api/health",
                method: "GET",
                expectedStatus: [200, 500], // 200 for healthy, 500 for service issues
                timeout: 30000,
                noAuth: true, // No authentication required
            };
            (0, globals_1.expect)(jenkinsHealthCheck.noAuth).toBe(true);
            (0, globals_1.expect)(jenkinsHealthCheck.expectedStatus).toContain(200);
        });
        (0, globals_1.it)("should support monitoring tools integration", async () => {
            const monitoringConfig = {
                healthEndpoints: [
                    { path: "/api/health", type: "basic" },
                    { path: "/api/health/database", type: "database" },
                    { path: "/api/health/webrtc", type: "service" },
                ],
                authRequired: false,
                responseFormat: "json",
            };
            (0, globals_1.expect)(monitoringConfig.authRequired).toBe(false);
            (0, globals_1.expect)(monitoringConfig.healthEndpoints).toHaveLength(3);
        });
    });
});
